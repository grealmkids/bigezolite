<div class="page-container">
  <div class="page-header">
    <h1>Communications</h1>
    <p>Send bulk SMS announcements to students and parents.</p>
  </div>

  <div class="communications-panel">
    <div class="form-group">
      <label for="recipient-filter">Recipient Filter</label>
      <select id="recipient-filter" class="form-control" [(ngModel)]="recipientFilter">
        <option value="All Students">All Students</option>
        <option *ngFor="let class of classes" [value]="class">{{ class }}</option>
      </select>
    </div>

    <div class="form-group">
      <label for="message">Message</label>
      <textarea 
        id="message" 
        class="form-control" 
        [(ngModel)]="message" 
        (ngModelChange)="onMessageChange($event)" 
        rows="8"
        placeholder="Type your announcement here...">
      </textarea>
      <div class="char-counter">
        <span>{{ characterCount }} characters</span>
        <span>(Consumes {{ smsCreditsConsumed }} SMS credit<span *ngIf="smsCreditsConsumed > 1">s</span>)</span>
      </div>
    </div>

    <div class="send-action">
      <button class="btn btn-secondary" (click)="calculate()" [disabled]="!message || isSending">Calculate</button>
      <p class="credits-info">Your current SMS credit balance is: <strong>{{ communicationService.smsCreditBalance$ | async }}</strong></p>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" *ngIf="isPreview && preview" (click)="closePreview()">
      <div class="preview-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Campaign Preview</h3>
          <button class="close-btn" (click)="closePreview()" type="button">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="preview-stats">
            <div class="stat-item">
              <span class="stat-label">Recipients</span>
              <span class="stat-value">{{ preview.recipientCount }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Estimated Cost</span>
              <span class="stat-value">UGX {{ preview.estimatedCost | number:'1.0-0' }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Current Balance</span>
              <span class="stat-value" [class.insufficient]="preview.currentBalance < preview.estimatedCost">UGX {{ preview.currentBalance | number:'1.0-0' }}</span>
            </div>
          </div>
          
          <div class="balance-check" *ngIf="preview.currentBalance < preview.estimatedCost">
            <div class="warning-message">
              <strong>⚠️ Insufficient Balance</strong>
              <p>You need UGX {{ (preview.estimatedCost - preview.currentBalance) | number:'1.0-0' }} more to send this campaign.</p>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closePreview()" type="button">Cancel</button>
          <button class="btn btn-success" 
                  *ngIf="preview.currentBalance >= preview.estimatedCost" 
                  (click)="sendBulkSms()" 
                  [disabled]="isSending"
                  type="button">
            <span *ngIf="!isSending">Send Campaign</span>
            <span *ngIf="isSending">Sending...</span>
          </button>
          <button class="btn btn-danger" 
                  *ngIf="preview.currentBalance < preview.estimatedCost" 
                  (click)="router.navigate(['/subscription'])"
                  type="button">
            Top Up Balance
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
