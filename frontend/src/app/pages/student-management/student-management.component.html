<div class="page-container">
  <div class="page-header">
    <h1>Student Management</h1>

    <!-- Mobile icon-only row -->
    <div class="header-actions-mobile">
      <button class="icon-btn" (click)="refreshStudents()" [disabled]="isLoading" aria-label="Refresh">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
          <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
        </svg>
      </button>
      <button
        class="icon-btn"
        (click)="downloadPDF()"
        [disabled]="displayedStudents.length === 0 || isLoading"
        aria-label="Download PDF"
      >
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      </button>
    </div>

    <div class="header-actions">
      <button class="refresh-btn" (click)="refreshStudents()" [disabled]="isLoading">
        <span class="icon" style="margin-right:6px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
            <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
          </svg>
        </span>
        Refresh
      </button>
      <button
        class="download-pdf-btn"
        (click)="downloadPDF()"
        [disabled]="displayedStudents.length === 0 || isLoading"
      >
        <span class="icon">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </span>
        Download PDF
      </button>
      <button class="add-student-btn" (click)="openStudentModal()">
        + Add New Student
      </button>
    </div>
  </div>

  <div class="controls-container">
    <div class="search-bar">
      <input
        type="text"
        placeholder="Search by name or registration number..."
        #searchInput
        (input)="onSearch(searchInput.value)"
      />
    </div>
    <div class="filters">
      <select #classFilter (change)="onClassChange(classFilter.value)">
        <option value="">All Classes</option>
        <option *ngFor="let class of classes" [value]="class">
          {{ class }}
        </option>
      </select>
      <select #statusFilter (change)="onStatusChange(statusFilter.value)">
        <option value="">All Statuses</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
        <option value="Expelled">Expelled</option>
        <option value="Alumni">Alumni</option>
        <option value="Suspended">Suspended</option>
        <option value="Sick">Sick</option>
      </select>
      <select #feesStatusFilter (change)="onFeesStatusChange(feesStatusFilter.value)">
        <option value="">All Fees Status</option>
        <option value="Paid">Paid</option>
        <option value="Pending">Partially Paid</option>
        <option value="Defaulter">Defaulter</option>
      </select>
      <select #yearFilter (change)="onYearChange(yearFilter.value)">
        <option value="">All Years</option>
        <option *ngFor="let year of years" [value]="year">{{ year }}</option>
      </select>
    </div>
  </div>

  <div class="student-list-container">
    <div class="student-list-container">
      <!-- Pagination & summary above the table -->
      <div
        class="table-header-controls"
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 0.8rem;
          margin-bottom: 0.8rem;
        "
      >
        <div style="display: flex; align-items: center; gap: 0.8rem">
          <div class="pagination-controls">
            <button
              class="btn"
              [disabled]="pageEvent.pageIndex <= 0"
              (click)="prevPage()"
            >
              Previous
            </button>
            <span>Page {{ pageEvent.pageIndex + 1 }} of {{ totalPages }}</span>
            <button
              class="btn"
              [disabled]="pageEvent.pageIndex >= totalPages - 1"
              (click)="nextPage()"
            >
              Next
            </button>
          </div>
          <label style="margin-left: 0.8rem"
            >Per page:
            <select
              [value]="pageEvent.pageSize"
              (change)="changePageSize(+$any($event.target).value)"
            >
              <option [value]="5">5</option>
              <option [value]="10">10</option>
              <option [value]="25">25</option>
              <option [value]="50">50</option>
            </select>
          </label>
        </div>

        <div class="table-summary">
          Showing {{ displayedStudents.length }} of
          {{ pageEvent.length || 0 }} students
        </div>
      </div>

      <ng-container *ngIf="!isLoading">
        <div *ngIf="displayedStudents.length === 0" class="no-results-alert">
          No students found matching your search criteria
        </div>

        <!-- Conditional tables: if fees status filter is active, show fees details table -->
        <ng-container *ngIf="!hasFeesFilter(); else feesTable">
          <table *ngIf="displayedStudents.length > 0" class="student-table">
            <thead>
              <tr>
                <th style="width: 50px">#</th>
                <th (click)="onSort('reg_number')" class="hide-mobile">
                  Reg Number
                </th>
                <th (click)="onSort('student_name')">Student Name</th>
                <th (click)="onSort('class_name')">Class</th>
                <th (click)="onSort('student_status')" class="hide-mobile">
                  Status
                </th>
                <th (click)="onSort('fees_status')" class="hide-mobile">
                  Fees Status
                </th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="isLoading">
                <td colspan="7" class="table-spinner">
                  <app-loading-spinner></app-loading-spinner>
                </td>
              </tr>
              <tr *ngFor="let student of displayedStudents; let i = index">
                <td>{{ pageEvent.pageIndex * pageEvent.pageSize + i + 1 }}</td>
                <td class="hide-mobile">{{ student.reg_number | noDash }}</td>
                <td>{{ student.student_name }}</td>
                <td>{{ student?.class_name || "" }}</td>
                <td class="hide-mobile">
                  <span
                    class="status"
                    [ngClass]="(student?.student_status || '').toLowerCase()"
                    >{{ student?.student_status || "" }}</span
                  >
                </td>
                <td class="hide-mobile">
                  <span
                    class="fees-status"
                    [ngClass]="(student?.fees_status || '').toLowerCase()"
                    >{{ formatFeesStatus(student?.fees_status) }}</span
                  >
                </td>
                <td class="actions">
                  <button class="action-btn fees filled" (click)="openFeesModal(student)">
                    <span class="icon">
                      <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v2.93zM11 7h2v6h-2zm0 8h2v2h-2z" />
                      </svg>
                    </span>
                    FEES
                  </button>
                  <button class="action-btn edit filled alt" (click)="openStudentModal(student)">
                    <span class="icon">
                      <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                      </svg>
                    </span>
                    EDIT
                  </button>
                  <button class="action-btn sms filled" (click)="openSmsModal(student)">
                    <span class="icon">
                      <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 14H6v-2h12v2zm0-4H6v-2h12v2zm0-4H6V6h12v2z" />
                      </svg>
                    </span>
                    SMS
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-container>
        <ng-template #feesTable>
          <table class="student-table fees-mode">
            <thead>
              <tr>
                <th style="width: 50px">#</th>
                <th>Reg Number</th>
                <th>Student Name</th>
                <th>Class</th>
                <th>Category</th>
                <th>Fees Status</th>
                <th>Term</th>
                <th>Year</th>
                <th>Total Due</th>
                <th>Amount Paid</th>
                <th>Balance</th>
                <th>Parent Phone</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="loadingFees">
                <td colspan="10" class="table-spinner">
                  <app-loading-spinner></app-loading-spinner>
                </td>
              </tr>
              <tr *ngFor="let row of displayedFeeRows; let i = index">
                <td>{{ pageEvent.pageIndex * pageEvent.pageSize + i + 1 }}</td>
                <td>{{ row.reg }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.klass }}</td>
                <td>{{ row.category }}</td>
                <td>
                  <span class="fees-status" [ngClass]="feesClassFromLabel(deriveFeesStatus(row.total, row.paid, row.balance))">
                    {{ deriveFeesStatus(row.total, row.paid, row.balance) }}
                  </span>
                </td>
                <td>{{ row.term }}</td>
                <td>{{ row.year }}</td>
                <td>{{ row.total | number:'1.0-0' }}</td>
                <td>{{ row.paid  | number:'1.0-0' }}</td>
                <td [ngClass]="(row.balance || 0) > 0 ? 'amount-neg' : 'amount-pos'">{{ row.balance | number:'1.0-0' }}</td>
                <td>{{ row.phone }}</td>
              </tr>
            </tbody>
          </table>
        </ng-template>

        <!-- Simple pagination controls (replaces MatPaginator) -->
        <div
          class="pagination-controls"
          style="
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 0.8rem;
          "
        >
          <button
            class="btn"
            [disabled]="pageEvent.pageIndex <= 0"
            (click)="prevPage()"
          >
            Previous
          </button>
          <div>Page {{ pageEvent.pageIndex + 1 }} of {{ totalPages }}</div>
          <button
            class="btn"
            [disabled]="pageEvent.pageIndex >= totalPages - 1"
            (click)="nextPage()"
          >
            Next
          </button>
          <label style="margin-left: 0.8rem"
            >Per page:
            <select
              [value]="pageEvent.pageSize"
              (change)="changePageSize(+$any($event.target).value)"
            >
              <option [value]="5">5</option>
              <option [value]="10">10</option>
              <option [value]="25">25</option>
              <option [value]="50">50</option>
            </select>
          </label>
        </div>
      </ng-container>
    </div>

    <!-- Modals -->
    <app-student-modal
      *ngIf="isStudentModalOpen"
      [student]="selectedStudent"
      (close)="closeStudentModal()"
      (studentUpserted)="onStudentUpserted()"
    >
    </app-student-modal>

    <app-fees-management-modal
      *ngIf="isFeesModalOpen"
      [student]="selectedStudent"
      (close)="closeFeesModal()"
    >
    </app-fees-management-modal>

    <app-sms-student-modal
      *ngIf="isSmsModalOpen"
      [student]="selectedStudent"
      (close)="closeSmsModal()"
    >
    </app-sms-student-modal>
  </div>
</div>
