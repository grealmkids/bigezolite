<div class="bulk-fees-reminders-container">
  <div class="page-header">
    <h1>ğŸ“‹ Bulk Fees Reminders</h1>
    <p class="subtitle">Send payment reminders to students with outstanding balances</p>
  </div>

  <div class="content-card">
    <!-- Settings Form - Hidden when preview is shown -->
    <form (ngSubmit)="sendBulkReminders()" class="reminder-form" *ngIf="!showPreview">
      
      <!-- Threshold Amount -->
      <div class="form-group">
        <label for="threshold">
          ğŸ’° Minimum Balance Threshold (UGX)
          <span class="help-text">Only send to students with balance â‰¥ this amount</span>
        </label>
        <input
          type="number"
          id="threshold"
          [(ngModel)]="thresholdAmount"
          name="threshold"
          min="0"
          step="1000"
          required
          class="form-control"
          placeholder="1000"
        />
      </div>

      <!-- Custom Deadline (Optional) -->
      <div class="form-group">
        <label for="deadline">
          ğŸ“… Payment Deadline (Optional)
          <span class="help-text">If set, this deadline will be used for all reminders. Otherwise, individual due dates from records will be used.</span>
        </label>
        <input
          type="date"
          id="deadline"
          [(ngModel)]="customDeadline"
          name="deadline"
          class="form-control"
        />
      </div>

      <!-- Class Filter -->
      <div class="form-group">
        <label for="class">
          ğŸ“ Filter by Class
        </label>
        <select
          id="class"
          [(ngModel)]="selectedClass"
          name="class"
          class="form-control"
          [disabled]="loadingClasses"
        >
          <option *ngFor="let cls of classes" [value]="cls">{{ cls }}</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="form-group">
        <label for="status">
          ğŸ‘¤ Filter by Student Status
        </label>
        <select
          id="status"
          [(ngModel)]="selectedStatus"
          name="status"
          class="form-control"
        >
          <option *ngFor="let status of studentStatuses" [value]="status">{{ status }}</option>
        </select>
      </div>

      <!-- Term/Year Filters -->
      <div class="form-group">
        <label for="term">ğŸ—“ï¸ Filter by Term</label>
        <select id="term" [(ngModel)]="selectedTerm" name="term" class="form-control">
          <option value="">All Terms</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="form-group">
        <label for="year">ğŸ“† Filter by Year</label>
        <select id="year" [(ngModel)]="selectedYear" name="year" class="form-control">
          <option value="">All Years</option>
          <option *ngFor="let y of years" [value]="y">{{ y }}</option>
        </select>
      </div>

      <!-- Fees Status Filter -->
      <div class="form-group">
        <label for="feesStatus">ğŸ’¼ Filter by Fees Status</label>
        <select id="feesStatus" [(ngModel)]="selectedFeesStatus" name="feesStatus" class="form-control">
          <option value="">All Fees Status</option>
          <option value="Paid">Paid</option>
          <option value="Pending">Partially Paid</option>
          <option value="Defaulter">Defaulter</option>
        </select>
      </div>

      <!-- Message Type -->
      <div class="form-group">
        <label for="messageType">âœ‰ï¸ Message Type</label>
        <select id="messageType" [(ngModel)]="messageType" (ngModelChange)="onMessageTypeChange($event)" name="messageType" class="form-control">
          <option value="detailed">Standard Fees Reminder (mimics single)</option>
          <option value="sent_home">Sent Home Notice (customizable)</option>
          <option value="custom">Custom Message</option>
        </select>
        <span class="help-text" *ngIf="messageType === 'detailed'">Uses each student's top outstanding fee record with term/year and due date.</span>
      </div>

      <!-- Template editor for sent_home/custom -->
      <div class="form-group" *ngIf="messageType === 'sent_home' || messageType === 'custom'">
        <label for="template">Message Template</label>
        <textarea id="template" [(ngModel)]="messageTemplate" name="template" rows="4" class="form-control" placeholder="Enter your message... See placeholders list below."></textarea>
        <span class="help-text">
          Placeholders supported:
          <code>{{'{'}}child's name{{'}'}}</code>,
          <code>{{'{'}}student_name{{'}'}}</code>,
          <code>{{'{'}}fee_name{{'}'}}</code>,
          <code>{{'{'}}today's date{{'}'}}</code>,
          <code>{{'{'}}RSVP number{{'}'}}</code>,
          <code>{{'{'}}School name{{'}'}}</code>,
          <code>{{'{'}}term{{'}'}}</code>,
          <code>{{'{'}}year{{'}'}}</code>,
          <code>{{'{'}}balance{{'}'}}</code>,
          <code>{{'{'}}amount_paid{{'}'}}</code>,
          <code>{{'{'}}total_due{{'}'}}</code>,
          <code>{{'{'}}due_date{{'}'}}</code>
        </span>
      </div>

      <!-- Summary Info -->
      <div class="info-box">
        <h3>ğŸ“¤ Reminder Settings</h3>
        <ul>
          <li><strong>Threshold:</strong> UGX {{ thresholdAmount | number }}</li>
          <li><strong>Class:</strong> {{ selectedClass }}</li>
          <li><strong>Status:</strong> {{ selectedStatus }}</li>
          <li><strong>Term:</strong> {{ selectedTerm || 'All' }}</li>
          <li><strong>Year:</strong> {{ selectedYear || 'All' }}</li>
          <li><strong>Fees Status:</strong> {{ selectedFeesStatus || 'All' }}</li>
          <li><strong>Deadline:</strong> {{ customDeadline || 'Use individual due dates' }}</li>
          <li><strong>Message Type:</strong> {{ messageType }}</li>
        </ul>
      </div>

      <!-- Preview Button -->
      <div class="form-actions">
        <button
          type="button"
          class="preview-btn"
          (click)="loadPreview()"
          [disabled]="isLoadingPreview"
        >
          <span *ngIf="!isLoadingPreview">ğŸ‘ï¸ Preview Campaign</span>
          <span *ngIf="isLoadingPreview">â³ Loading...</span>
        </button>
      </div>
    </form>

    <!-- Preview Section - Replaces form when shown -->
    <div class="preview-section" *ngIf="showPreview && previewData">
      <h3>ğŸ“Š Campaign Preview</h3>
      
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="card-left">
            <div class="card-icon">ğŸ‘¥</div>
          </div>
          <div class="card-right">
            <div class="analytics-label">Recipients</div>
            <div class="analytics-value">{{ previewData.recipientCount }}</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-left">
            <div class="card-icon">ğŸ’µ</div>
          </div>
          <div class="card-right">
            <div class="analytics-label">Total Balance</div>
            <div class="analytics-value">UGX {{ previewData.totalBalance | number:'1.0-0' }}</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-left">
            <div class="card-icon">ğŸ’¸</div>
          </div>
          <div class="card-right">
            <div class="analytics-label">Estimated Cost</div>
            <div class="analytics-value">UGX {{ previewData.estimatedCost | number:'1.0-0' }}</div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-left">
            <div class="card-icon">âœ‰ï¸</div>
          </div>
          <div class="card-right">
            <div class="analytics-label">Message Length</div>
            <div class="analytics-value">{{ previewData.messageLength }} chars ({{ previewData.smsUnits }} SMS)</div>
          </div>
        </div>
      </div>

      <div class="sample-message-box">
        <h4>ğŸ“ Sample Message</h4>
        <div class="sample-message">{{ previewData.sampleMessage }}</div>
      </div>

      <div class="recipients-preview">
        <h4>ğŸ‘¥ Recipients ({{ previewData.recipientCount }} total)</h4>
        <div class="recipients-table">
          <div class="recipient-row header">
            <div class="recipient-col">Student Name</div>
            <div class="recipient-col">Phone</div>
            <div class="recipient-col">Balance</div>
          </div>
          <div class="recipient-row" *ngFor="let recipient of previewData.recipients.slice(0, 10)">
            <div class="recipient-col">{{ recipient.studentName }}</div>
            <div class="recipient-col">{{ recipient.phoneNumber }}</div>
            <div class="recipient-col">UGX {{ recipient.balance | number:'1.0-0' }}</div>
          </div>
          <div class="recipient-row note" *ngIf="previewData.recipients.length > 10">
            <div class="recipient-col" colspan="3">...and {{ previewData.recipients.length - 10 }} more</div>
          </div>
        </div>
      </div>

      <!-- Preview Action Buttons -->
      <div class="preview-actions">
        <button
          type="button"
          class="cancel-btn"
          (click)="cancelPreview()"
          [disabled]="isSending"
        >
          â† Back to Settings
        </button>
        <button
          type="button"
          class="send-btn"
          (click)="sendBulkReminders()"
          [disabled]="isSending"
        >
          <span *ngIf="!isSending">ğŸ“§ Send Fees Reminders</span>
          <span *ngIf="isSending">â³ Sending...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="help-section">
    <h3>â„¹ï¸ How It Works</h3>
    <div class="help-grid">
      <div class="help-item">
        <h4>1. Set Threshold</h4>
        <p>Only students with outstanding balance greater than or equal to the threshold will receive reminders.</p>
      </div>
      <div class="help-item">
        <h4>2. Filter Recipients</h4>
        <p>Narrow down recipients by class and student status (e.g., only Active students).</p>
      </div>
      <div class="help-item">
        <h4>3. Optional Deadline</h4>
        <p>Set a custom payment deadline for this campaign, or leave empty to use each student's individual due date.</p>
      </div>
      <div class="help-item">
        <h4>4. Send Reminders</h4>
        <p>SMS reminders will be sent to parents with student name, amount due, and payment details.</p>
      </div>
    </div>
  </div>
</div>
