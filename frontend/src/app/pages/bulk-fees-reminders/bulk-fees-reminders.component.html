<div class="bulk-fees-reminders-container">
  <div class="page-header">
    <h1>📋 Bulk Fees Reminders</h1>
    <p class="subtitle">Send payment reminders to students with outstanding balances</p>
  </div>

  <div class="content-card">
    <form (ngSubmit)="sendBulkReminders()" class="reminder-form">
      
      <!-- Threshold Amount -->
      <div class="form-group">
        <label for="threshold">
          💰 Minimum Balance Threshold (UGX)
          <span class="help-text">Only send to students with balance ≥ this amount</span>
        </label>
        <input
          type="number"
          id="threshold"
          [(ngModel)]="thresholdAmount"
          name="threshold"
          min="0"
          step="1000"
          required
          class="form-control"
          placeholder="1000"
        />
      </div>

      <!-- Custom Deadline (Optional) -->
      <div class="form-group">
        <label for="deadline">
          📅 Payment Deadline (Optional)
          <span class="help-text">If set, this deadline will be used for all reminders. Otherwise, individual due dates from records will be used.</span>
        </label>
        <input
          type="date"
          id="deadline"
          [(ngModel)]="customDeadline"
          name="deadline"
          class="form-control"
        />
      </div>

      <!-- Class Filter -->
      <div class="form-group">
        <label for="class">
          🎓 Filter by Class
        </label>
        <select
          id="class"
          [(ngModel)]="selectedClass"
          name="class"
          class="form-control"
          [disabled]="loadingClasses"
        >
          <option *ngFor="let cls of classes" [value]="cls">{{ cls }}</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="form-group">
        <label for="status">
          👤 Filter by Student Status
        </label>
        <select
          id="status"
          [(ngModel)]="selectedStatus"
          name="status"
          class="form-control"
        >
          <option *ngFor="let status of studentStatuses" [value]="status">{{ status }}</option>
        </select>
      </div>

      <!-- Summary Info -->
      <div class="info-box">
        <h3>📤 Reminder Settings</h3>
        <ul>
          <li><strong>Threshold:</strong> UGX {{ thresholdAmount | number }}</li>
          <li><strong>Class:</strong> {{ selectedClass }}</li>
          <li><strong>Status:</strong> {{ selectedStatus }}</li>
          <li><strong>Deadline:</strong> {{ customDeadline || 'Use individual due dates' }}</li>
        </ul>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button
          type="button"
          class="preview-btn"
          (click)="loadPreview()"
          [disabled]="isLoadingPreview || isSending"
        >
          <span *ngIf="!isLoadingPreview">👁️ Preview</span>
          <span *ngIf="isLoadingPreview">⏳ Loading...</span>
        </button>
        <button
          type="submit"
          class="send-btn"
          [disabled]="isSending || !showPreview"
        >
          <span *ngIf="!isSending">📧 Send Fees Reminders</span>
          <span *ngIf="isSending">⏳ Sending...</span>
        </button>
      </div>
    </form>

    <!-- Preview Section -->
    <div class="preview-section" *ngIf="showPreview && previewData">
      <h3>📊 Campaign Preview</h3>
      
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-label">Recipients</div>
          <div class="analytics-value">{{ previewData.recipientCount }}</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Total Balance</div>
          <div class="analytics-value">UGX {{ previewData.totalBalance | number:'1.0-0' }}</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Estimated Cost</div>
          <div class="analytics-value">UGX {{ previewData.estimatedCost | number:'1.0-0' }}</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Message Length</div>
          <div class="analytics-value">{{ previewData.messageLength }} chars ({{ previewData.smsUnits }} SMS)</div>
        </div>
      </div>

      <div class="sample-message-box">
        <h4>📝 Sample Message</h4>
        <div class="sample-message">{{ previewData.sampleMessage }}</div>
      </div>

      <div class="recipients-preview">
        <h4>👥 Recipients ({{ previewData.recipientCount }} total)</h4>
        <div class="recipients-table">
          <div class="recipient-row header">
            <div class="recipient-col">Student Name</div>
            <div class="recipient-col">Phone</div>
            <div class="recipient-col">Balance</div>
          </div>
          <div class="recipient-row" *ngFor="let recipient of previewData.recipients.slice(0, 10)">
            <div class="recipient-col">{{ recipient.studentName }}</div>
            <div class="recipient-col">{{ recipient.phoneNumber }}</div>
            <div class="recipient-col">UGX {{ recipient.balance | number:'1.0-0' }}</div>
          </div>
          <div class="recipient-row note" *ngIf="previewData.recipients.length > 10">
            <div class="recipient-col" colspan="3">...and {{ previewData.recipients.length - 10 }} more</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="help-section">
    <h3>ℹ️ How It Works</h3>
    <div class="help-grid">
      <div class="help-item">
        <h4>1. Set Threshold</h4>
        <p>Only students with outstanding balance greater than or equal to the threshold will receive reminders.</p>
      </div>
      <div class="help-item">
        <h4>2. Filter Recipients</h4>
        <p>Narrow down recipients by class and student status (e.g., only Active students).</p>
      </div>
      <div class="help-item">
        <h4>3. Optional Deadline</h4>
        <p>Set a custom payment deadline for this campaign, or leave empty to use each student's individual due date.</p>
      </div>
      <div class="help-item">
        <h4>4. Send Reminders</h4>
        <p>SMS reminders will be sent to parents with student name, amount due, and payment details.</p>
      </div>
    </div>
  </div>
</div>
