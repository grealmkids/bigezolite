<div class="analytics-container">
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">analytics</mat-icon>
      <h1 class="page-title">Dashboard</h1>
    </div>

    <div class="header-actions">
      <!-- Filters -->
      <mat-form-field appearance="outline" class="dense-mn">
        <mat-select [value]="selectedYear" (selectionChange)="onYearChange($event.value)" placeholder="Year">
          <mat-option *ngFor="let y of years" [value]="y">{{ y }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="dense-mn">
        <mat-select [value]="selectedTerm" (selectionChange)="onTermChange($event.value)" placeholder="Term">
          <mat-option [value]="''">All Terms</mat-option>
          <mat-option [value]="1">Term 1</mat-option>
          <mat-option [value]="2">Term 2</mat-option>
          <mat-option [value]="3">Term 3</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button (click)="refresh()" [disabled]="anyLoading" matTooltip="Refresh Data">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <div *ngIf="loading.overview" class="loading-state">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading analytics...</p>
  </div>

  <div *ngIf="!loading.overview && analytics" class="dashboard-content">

    <!-- Top Row: Key Metrics -->
    <div class="metrics-row">
      <div class="metric-card primary">
        <div class="metric-header">
          <span class="label">Total Students</span>
          <mat-icon>groups</mat-icon>
        </div>
        <div class="metric-value">{{ analytics.totalStudents }}</div>
        <div class="metric-trend">
          <span class="trend-up">Active: {{ analytics.activeStudents }}</span>
        </div>
      </div>

      <div class="metric-card success">
        <div class="metric-header">
          <span class="label">Total Collected</span>
          <mat-icon>payments</mat-icon>
        </div>
        <div class="metric-value small-text">{{ analytics.totalPaidAmount | currency:'UGX ':'symbol':'1.0-0' }}</div>
        <div class="metric-trend">
          <span>{{ analytics.paidStudentsCount }} students</span>
        </div>
      </div>

      <div class="metric-card danger">
        <div class="metric-header">
          <span class="label">Defaulters</span>
          <mat-icon>warning</mat-icon>
        </div>
        <div class="metric-value small-text">{{ analytics.totalDefaulterBalance | currency:'UGX ':'symbol':'1.0-0' }}
        </div>
        <div class="metric-trend">
          <span>{{ analytics.defaulterStudentsCount }} students</span>
        </div>
      </div>

      <div class="metric-card info">
        <div class="metric-header">
          <span class="label">SMS Balance</span>
          <mat-icon>sms</mat-icon>
        </div>
        <div class="metric-value small-text">{{ analytics.smsBalance | currency:'UGX ':'symbol':'1.0-0' }}</div>
        <div class="metric-trend">
          <span>{{ analytics.smsCount }} credits</span>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Students per Class</h3>
        <div class="chart-container">
          <canvas baseChart [data]="classChartData" [options]="classChartOptions" [type]="'bar'">
          </canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Gender Ratio</h3>
        <div class="chart-container doughnut">
          <canvas baseChart [data]="genderChartData" [options]="genderChartOptions" [type]="'doughnut'">
          </canvas>
          <div class="chart-overlay">
            <div class="total">{{ analytics.activeStudents }}</div>
            <div class="label">Active</div>
          </div>
        </div>
        <div class="gender-legend">
          <div class="item">
            <span class="dot boy"></span>
            <span class="lbl">Boys</span>
            <span class="val">{{ analytics.activeBoys }}</span>
          </div>
          <div class="item">
            <span class="dot girl"></span>
            <span class="lbl">Girls</span>
            <span class="val">{{ analytics.activeGirls }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secondary Metrics (Status) -->
    <div class="status-strip">
      <div class="status-item">
        <span class="label">Inactive</span>
        <span class="value">{{ analytics.inactiveStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Alumni</span>
        <span class="value">{{ analytics.alumniStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Expelled</span>
        <span class="value">{{ analytics.expelledStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Suspended</span>
        <span class="value">{{ analytics.suspendedStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Sick</span>
        <span class="value">{{ analytics.sickStudents }}</span>
      </div>
    </div>

  </div>
</div>