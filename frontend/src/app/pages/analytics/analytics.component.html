<div class="analytics-container">
  <div class="page-header">
    <div class="header-content">
      <mat-icon class="header-icon">analytics</mat-icon>
      <h1 class="page-title">Dashboard</h1>
    </div>

    <div class="header-actions">
      <!-- Filters -->
      <mat-form-field appearance="outline" class="dense-mn">
        <mat-select [value]="selectedYear" (selectionChange)="onYearChange($event.value)" placeholder="Year">
          <mat-option *ngFor="let y of years" [value]="y">{{ y }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="dense-mn">
        <mat-select [value]="selectedTerm" (selectionChange)="onTermChange($event.value)" placeholder="Term">
          <mat-option [value]="''">All Terms</mat-option>
          <mat-option [value]="1">Term 1</mat-option>
          <mat-option [value]="2">Term 2</mat-option>
          <mat-option [value]="3">Term 3</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button (click)="refresh()" [disabled]="anyLoading" matTooltip="Refresh Data">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <div *ngIf="analytics || loading.overview" class="dashboard-content">

    <!-- Top Row: Key Metrics -->
    <div class="metrics-row">
      <!-- Card 1 -->
      <div class="metric-card primary">
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="30"></mat-spinner>
        </div>
        <ng-container *ngIf="analytics">
          <div class="metric-header">
            <span class="label">Total Students</span>
            <mat-icon>groups</mat-icon>
          </div>
          <div class="metric-value">{{ analytics.totalStudents }}</div>
          <div class="metric-trend">
            <span class="trend-up">Active: {{ analytics.activeStudents }}</span>
          </div>
        </ng-container>
      </div>

      <!-- Card 2 -->
      <div class="metric-card success">
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="30"></mat-spinner>
        </div>
        <ng-container *ngIf="analytics">
          <div class="metric-header">
            <span class="label">Total Collected</span>
            <mat-icon>payments</mat-icon>
          </div>
          <div class="metric-value small-text metric-val-color">{{ analytics.totalPaidAmount | currency:'UGX
            ':'symbol':'1.0-0' }}</div>
          <div class="metric-trend">
            <span>{{ analytics.paidStudentsCount }} students</span>
          </div>
        </ng-container>
      </div>

      <!-- Card 3 -->
      <div class="metric-card danger">
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="30"></mat-spinner>
        </div>
        <ng-container *ngIf="analytics">
          <div class="metric-header">
            <span class="label">Defaulters</span>
            <mat-icon>warning</mat-icon>
          </div>
          <div class="metric-value small-text metric-val-color">{{ analytics.totalDefaulterBalance | currency:'UGX
            ':'symbol':'1.0-0' }}</div>
          <div class="metric-trend">
            <span>{{ analytics.defaulterStudentsCount }} students</span>
          </div>
        </ng-container>
      </div>

      <!-- Card 4 -->
      <div class="metric-card info">
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="30"></mat-spinner>
        </div>
        <ng-container *ngIf="analytics">
          <div class="metric-header">
            <span class="label">SMS Balance</span>
            <mat-icon>sms</mat-icon>
          </div>
          <div class="metric-value small-text">{{ analytics.smsBalance | currency:'UGX ':'symbol':'1.0-0' }}</div>
          <div class="metric-trend">
            <span>{{ analytics.smsCount }} credits</span>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Students per Class</h3>
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        <div class="chart-container" *ngIf="analytics">
          <canvas baseChart [data]="classChartData" [options]="classChartOptions" [type]="'bar'">
          </canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Gender Ratio</h3>
        <div *ngIf="loading.overview && !analytics" class="card-loader">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
        <div class="chart-container doughnut" *ngIf="analytics">
          <canvas baseChart [data]="genderChartData" [options]="genderChartOptions" [type]="'doughnut'">
          </canvas>
          <div class="chart-overlay">
            <div class="total">{{ analytics.activeStudents }}</div>
            <div class="label">Active</div>
          </div>
        </div>
        <div class="gender-legend" *ngIf="analytics">
          <div class="item">
            <span class="dot boy"></span>
            <span class="lbl">Boys</span>
            <span class="val">{{ analytics.activeBoys }}</span>
          </div>
          <div class="item">
            <span class="dot girl"></span>
            <span class="lbl">Girls</span>
            <span class="val">{{ analytics.activeGirls }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secondary Metrics (Status) -->
    <div class="status-strip" *ngIf="analytics">
      <div class="status-item">
        <span class="label">Inactive</span>
        <span class="value">{{ analytics.inactiveStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Alumni</span>
        <span class="value">{{ analytics.alumniStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Expelled</span>
        <span class="value">{{ analytics.expelledStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Suspended</span>
        <span class="value">{{ analytics.suspendedStudents }}</span>
      </div>
      <div class="divider"></div>
      <div class="status-item">
        <span class="label">Sick</span>
        <span class="value">{{ analytics.sickStudents }}</span>
      </div>
    </div>

  </div>
</div>