<div class="modal-overlay" (click)="close.emit()">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Fees for {{ student?.student_name }}</h2>
      <button class="close-btn" (click)="close.emit()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Form to Add New Fee Record -->
      <div class="add-record-form">
        <h3>Add New Term Record</h3>
        <form [formGroup]="feeForm" (ngSubmit)="onAddFeeRecord()">
          <div class="form-row">
            <div class="form-group">
              <label>Term</label>
              <select formControlName="term">
                <option>1</option>
                <option>2</option>
                <option>3</option>
              </select>
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="number" formControlName="year" />
            </div>
            <div class="form-group">
              <label>Total Fees Due</label>
              <input type="number" formControlName="total_fees_due" />
            </div>
            <div class="form-group">
              <label>Due Date</label>
              <input type="date" formControlName="due_date" />
            </div>
            <div class="form-group">
              <label>RSVP Number</label>
              <input type="text" formControlName="rsvp_number" />
            </div>
            <div class="form-group-action">
              <button type="submit" [disabled]="feeForm.invalid">+ Add</button>
            </div>
          </div>
        </form>
      </div>

      <!-- List of Existing Fee Records -->
      <div class="records-list">
        <h3>Payment History</h3>
        <table>
          <thead>
            <tr>
              <th>Term/Year</th>
              <th>Fee</th>
              <th>Total Due</th>
              <th>Amount Paid</th>
              <th>Balance</th>
              <th>Due Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let record of feeRecords"
              (click)="selectedFeeRecord = record"
              [class.selected]="
                selectedFeeRecord?.fee_record_id === record.fee_record_id
              "
            >
              <td>
                Term {{ record.term }}, {{ record.year }}
                <span
                  class="fees-status-badge"
                  [ngClass]="
                    feesClassFromLabel(
                      deriveFeesStatus(
                        record.total_fees_due,
                        record.amount_paid,
                        record.balance_due
                      )
                    )
                  "
                >
                  {{
                    deriveFeesStatus(
                      record.total_fees_due,
                      record.amount_paid,
                      record.balance_due
                    )
                  }}
                </span>
              </td>
              <td>
                {{
                  (record.fee_id && feeNames[record.fee_id]) || "School Fees"
                }}
              </td>
              <td>
                {{
                  record.total_fees_due | currency : "UGX " : "symbol" : "1.0-0"
                }}
              </td>
              <td>
                <ng-container
                  *ngIf="
                    editingRecordId !== record.fee_record_id;
                    else editAmountPaid
                  "
                >
                  {{
                    record.amount_paid | currency : "UGX " : "symbol" : "1.0-0"
                  }}
                </ng-container>
                <ng-template #editAmountPaid>
                  <input
                    type="number"
                    [(ngModel)]="editingAmountPaid"
                    [max]="record.total_fees_due"
                  />
                  <div
                    *ngIf="
                      editingAmountPaid != null &&
                      editingAmountPaid > record.total_fees_due
                    "
                    class="validation-error"
                  >
                    Amount paid cannot be greater than Total Due ({{
                      record.total_fees_due
                        | currency : "UGX " : "symbol" : "1.0-0"
                    }}).
                  </div>
                </ng-template>
              </td>
              <td
                [ngClass]="
                  (record.balance_due || 0) > 0 ? 'amount-neg' : 'amount-pos'
                "
              >
                {{
                  record.balance_due | currency : "UGX " : "symbol" : "1.0-0"
                }}
              </td>
              <td>{{ record.due_date | date : "mediumDate" }}</td>
              <td class="actions">
                <ng-container
                  *ngIf="
                    editingRecordId !== record.fee_record_id;
                    else saveCancelButtons
                  "
                >
                  <button
                    class="action-btn edit"
                    (click)="$event.stopPropagation(); startEditing(record)"
                  >
                    Edit
                  </button>
                  <button
                    class="action-btn reminder"
                    (click)="
                      $event.stopPropagation(); openReminderPreview(record)
                    "
                  >
                    <svg
                      class="mono-icon"
                      viewBox="0 0 24 24"
                      width="16"
                      height="16"
                      aria-hidden="true"
                    >
                      <path
                        d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"
                        fill="currentColor"
                      />
                    </svg>
                    Send Reminder
                  </button>
                  <button
                    class="action-btn cancel"
                    (click)="$event.stopPropagation(); onDeleteRecord(record)"
                  >
                    Delete
                  </button>
                </ng-container>
                <ng-template #saveCancelButtons>
                  <button
                    class="action-btn save"
                    (click)="
                      $event.stopPropagation();
                      onUpdateFeeRecord(record.fee_record_id)
                    "
                  >
                    Save
                  </button>
                  <button
                    class="action-btn cancel"
                    (click)="$event.stopPropagation(); cancelEditing()"
                  >
                    Cancel
                  </button>
                </ng-template>
              </td>
            </tr>
            <tr *ngIf="feeRecords?.length === 0">
              <td colspan="6" class="empty-state">
                No fee records found for this student.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-actions">
        <div *ngIf="showTermYearPicker" class="term-picker">
          <label>Term</label>
          <select [(ngModel)]="pickerTerm">
            <option [value]="1">1</option>
            <option [value]="2">2</option>
            <option [value]="3">3</option>
          </select>
          <label>Year</label>
          <input type="number" [(ngModel)]="pickerYear" />
          <button
            class="action-btn save"
            (click)="confirmPaymentHistoryPicker()"
          >
            Confirm
          </button>
          <button
            class="action-btn cancel"
            (click)="cancelPaymentHistoryPicker()"
          >
            Cancel
          </button>
        </div>

        <button
          type="button"
          class="send-history-btn"
          (click)="openPaymentHistoryPicker()"
          [disabled]="isSendingHistory"
          title="Choose term & year then preview"
        >
          <svg
            class="mono-icon"
            viewBox="0 0 24 24"
            width="16"
            height="16"
            aria-hidden="true"
          >
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14l4-4h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"
              fill="currentColor"
            />
          </svg>
          Send Payment History
        </button>

        <button type="button" class="cancel-btn" (click)="close.emit()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Fee Reminder Preview Modal -->
<app-fee-reminder-preview-modal
  *ngIf="showReminderPreview"
  [student]="student"
  [feeRecord]="selectedFeeRecord"
  [allFeeRecords]="feeRecords"
  [overrideMessage]="previewMessage"
  [modalTitle]="previewModalTitle"
  (close)="closeReminderPreview()"
></app-fee-reminder-preview-modal>
